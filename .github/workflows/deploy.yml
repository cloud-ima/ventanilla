name: Deploy Laravel to cPanel

on:
  push:
    branches:
      - main # Se ejecuta solo cuando subes cambios a la rama 'main'

jobs:
  # ============================================
  # TRABAJO 1: CI - Integración Continua (Tests)
  # ============================================
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, sqlite

      - name: Install Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"

      - name: Generate Key
        run: php artisan key:generate

      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Execute Tests
        run: php artisan test

  # ============================================
  # TRABAJO 2: CD - Despliegue Continuo
  # Estructura segura para cPanel:
  # - /home/usuario/ventanilla/     <- Código Laravel (fuera de public_html)
  # - /home/usuario/public_html/ <- Solo contenido de public/
  # ============================================
  deploy:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer Dependencies (Production)
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Install NPM dependencies
        run: npm ci

      - name: Build Frontend Assets
        run: npm run build

      # Modificar index.php para apuntar a la carpeta del proyecto
      - name: Prepare index.php for cPanel structure
        run: |
          sed -i "s|__DIR__.'/../|__DIR__.'/../ventanilla/|g" public/index.php

      # Generar token aleatorio para storage-link
      - name: Generate Storage Link Token
        id: storage_token
        run: echo "token=$(openssl rand -hex 32)" >> $GITHUB_OUTPUT

      # Crear archivo de token temporal para el script
      - name: Create Token File
        run: echo "${{ steps.storage_token.outputs.token }}" > public/.storage_token

      # ----------------------------------------
      # DEPLOY 1: Código Laravel -> /ventanilla/
      # (fuera de public_html, más seguro)
      # ----------------------------------------
      - name: Deploy App to /ventanilla/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          server-dir: /ventanilla/
          exclude: |
            **/.git*
            **/.git*/**
            **/.github/**
            **/node_modules/**
            **/tests/**
            **/public/**
            .editorconfig
            .env
            .env.*
            .env.example
            .gitattributes
            .gitignore
            README.md
            phpunit.xml
            phpstan.neon
            webpack.mix.js
            package.json
            package-lock.json

      # ----------------------------------------
      # DEPLOY 2: Carpeta public/ -> /public_html/
      # ----------------------------------------
      - name: Deploy Public to /public_html/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          local-dir: ./public/
          server-dir: /public_html/
          exclude: |
            **/.git*

      # ----------------------------------------
      # PASO 3: Ejecutar storage:link automáticamente
      # El script se auto-elimina después de ejecutarse
      # ----------------------------------------
      - name: Execute Storage Link
        run: |
          echo "Esperando 10 segundos para que el servidor procese los archivos..."
          sleep 10
          response=$(curl -s -w "\n%{http_code}" "${{ secrets.APP_URL }}/storage-link.php?token=${{ steps.storage_token.outputs.token }}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          echo "Response: $body"
          echo "HTTP Code: $http_code"
          if [ "$http_code" != "200" ]; then
            echo "⚠️ Storage link puede requerir configuración manual. Ver DEPLOY_SETUP.md"
          fi
